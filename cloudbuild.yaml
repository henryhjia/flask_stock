steps:
# 1. Install dependencies
- name: 'python:3.10'
  id: 'install-deps'
  entrypoint: 'pip'
  args: ['install', '-r', 'requirements.txt', '--user']

# 2. Run tests
- name: 'python:3.10'
  id: 'run-tests'
  entrypoint: 'python'
  args: ['-m', 'pytest']
  waitFor: ['install-deps']

# 3. Download proxy, start it, and run migrations
- name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
  id: 'migrate-database'
  entrypoint: 'bash'
  args:
  - '-c'
  - |
    # Explicitly fetch the database password from Secret Manager
    export DB_PASS=$$(gcloud secrets versions access latest --secret=DB_PASS)

    echo "--- Installing migration tools ---"
    python3 -m pip install yoyo-migrations pg8000 --break-system-packages
    echo "--- Downloading Cloud SQL Proxy ---"
    curl -o /workspace/cloud-sql-proxy https://storage.googleapis.com/cloud-sql-connectors/cloud-sql-proxy/v2.8.0/cloud-sql-proxy.linux.amd64
    chmod +x /workspace/cloud-sql-proxy
    echo "--- Starting Cloud SQL Proxy in background ---"
    /workspace/cloud-sql-proxy --quiet --private-ip ${_INSTANCE_CONNECTION_NAME} &
    echo "--- Waiting for proxy to initialize (5s) ---"
    sleep 5
    echo "--- Applying database migrations ---"
    # Construct the database URI and pass it directly to the command
    DB_URI="postgresql://${_DB_USER}@127.0.0.1:5432/${_DB_NAME}"
    yoyo apply --database "${DB_URI}" ./migrations
  env:
    - 'DB_USER=${_DB_USER}'
    - 'DB_NAME=${_DB_NAME}'
    - 'DB_PASS=$${DB_PASS}'
  waitFor: ['run-tests']

# 4. Build the container image
- name: 'gcr.io/cloud-builders/docker'
  id: 'build-image'
  args:
    - 'build'
    - '-t'
    - 'us-central1-docker.pkg.dev/$PROJECT_ID/flask-stock-repo/flask-stock-service:$COMMIT_SHA'
    - '.'
  waitFor: ['migrate-database']

# 4. Push the container image to Artifact Registry
- name: 'gcr.io/cloud-builders/docker'
  id: 'push-image'
  args:
    - 'push'
    - 'us-central1-docker.pkg.dev/$PROJECT_ID/flask-stock-repo/flask-stock-service:$COMMIT_SHA'
  waitFor: ['build-image']

# 5. Deploy to Cloud Run
- name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
  id: 'deploy-service'
  entrypoint: 'gcloud'
  args:
    - 'run'
    - 'deploy'
    - 'flask-stock-service'
    - '--image=us-central1-docker.pkg.dev/$PROJECT_ID/flask-stock-repo/flask-stock-service:$COMMIT_SHA'
    - '--region=us-central1'
    - '--allow-unauthenticated'
    - '--set-env-vars=INSTANCE_CONNECTION_NAME=${_INSTANCE_CONNECTION_NAME},DB_NAME=${_DB_NAME},DB_USER=${_DB_USER}'
    - '--set-secrets=DB_PASS=DB_PASS:latest'
  waitFor: ['push-image']

# Define user-defined variables
substitutions:
  _INSTANCE_CONNECTION_NAME: 'flask-stock-app-2025:us-central1:flask-stock-db-instance'
  _DB_NAME: 'flask_stock_db'
  _DB_USER: 'stock_user'

images:
- 'us-central1-docker.pkg.dev/$PROJECT_ID/flask-stock-repo/flask-stock-service:$COMMIT_SHA'

options:
  logging: CLOUD_LOGGING_ONLY